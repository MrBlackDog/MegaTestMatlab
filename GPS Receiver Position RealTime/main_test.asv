warning off
addpath('C:\MatlabWebSocket','C:\MatlabWebSocket\src','C:\MatlabWebSocket\examples');
sm = SimpleClient('ws://mrblackdog.ddns.net:5000/ws');
sm.send('State:Matlab');
load('эфемериды0412.mat')
Name = 'Smartphone1';

timestr = datestr(datetime);
timestr = [timestr(1:2) timestr(4:6) timestr(8:11) timestr(13:14) timestr(16:17) timestr(19:20)];
file = fopen([timestr '.txt'],'w');
N = str2num(Name(end));
    k = 0;
    for i = 1:5
        if N ~= i
            k = k + 1;
            phone(k) = i;
        end
    end
% sm.send('GetEphemeris:test test');
% a = sm.RawMeas;
% sm.RawMeasFlag = 0;
Database = [];
k = 0;
    while k < 100
%         k = k + 1;
%         sm.RawMeas
%         sm.RawMeasFlag
        if sm.RawMeasFlag
            % время приема в GPS времени компа
            TOW = GPSdatetime(datetime('now','TimeZone','Europe/London')); 
            % вывод принятого сообщения
            mes = sm.RawMeas;
            % если в сообщении больше 9 элементов (больше двух ПД), то это
            % хорошее сообщение и мы его заносим  в базу
            if length(split(mes)) > 9
            k = k + 1;
            out = decode_mes( mes, TOW );
            tic
            [ Database ] = DatabaseUPDATE( Database, out );
            fprintf(file,[num2str(TOW) ' ' mes '\r\n']); 
            if Database.flag
                OBS = Database.current_obs;
                Smartphones_list = Database.current_list;
                if sum(Smartphones_list) > 1
                Bases = Solver( Name, ephemeris, OBS, Smartphones_list, phone );
%                 Bases
                end
            end
            
            end
            sm.RawMeasFlag = 0;
        end
        pause(0.001)
    end
sm.close();
fclose(file);
 